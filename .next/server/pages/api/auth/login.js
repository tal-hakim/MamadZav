"use strict";(()=>{var e={};e.id=908,e.ids=[908],e.modules={1185:e=>{e.exports=require("mongoose")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,n)=>{Object.defineProperty(n,"l",{enumerable:!0,get:function(){return function e(n,o){return o in n?n[o]:"then"in n&&"function"==typeof n.then?n.then(n=>e(n,o)):"function"==typeof n&&"default"===o?n:void 0}}})},6644:(e,n,o)=>{o.r(n),o.d(n,{config:()=>m,default:()=>u,routeModule:()=>g});var r={};o.r(r),o.d(r,{default:()=>d});var t=o(1802),s=o(7153),i=o(6249),a=o(2250),c=o(8208),l=o(6864);async function d(e,n){if("POST"!==e.method)return n.status(405).json({message:"Method not allowed"});try{await (0,a.Z)();let{emailOrUsername:o,password:r}=e.body;if(!o||!r)return n.status(400).json({message:"Missing email/username or password"});let t=await c.n.findOne({$or:[{email:o.toLowerCase()},{username:o.toLowerCase()}]});if(!t||!await t.comparePassword(r))return n.status(401).json({message:"Invalid credentials"});let s=(0,l.R)(t._id),i={id:t._id,email:t.email,name:t.name,username:t.username,friends:t.friends,lastCheckIn:t.lastCheckIn};n.status(200).json({user:i,token:s})}catch(e){console.error("Login error:",e),n.status(500).json({message:"Error during login"})}}let u=(0,i.l)(r,"default"),m=(0,i.l)(r,"config"),g=new t.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/auth/login",pathname:"/api/auth/login",bundlePath:"",filename:""},userland:r})},2250:(e,n,o)=>{o.d(n,{Z:()=>a});var r=o(1185),t=o.n(r);let s=process.env.MONGODB_URI;if(!s)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let i=global.mongoose||{conn:null,promise:null};global.mongoose||(global.mongoose=i);let a=async function(){if(i.conn){if(1===t().connection.readyState)return console.log("Using cached database connection"),i.conn;console.log("Cached connection is no longer valid, creating new connection..."),i.conn=null,i.promise=null}if(i.promise)console.log("Using existing connection promise");else try{console.log("Creating new database connection...");let e=t();i.promise=t().connect(s,{bufferCommands:!1,serverSelectionTimeoutMS:1e4,socketTimeoutMS:45e3,family:4,maxPoolSize:10,minPoolSize:1,connectTimeoutMS:1e4,retryWrites:!0,retryReads:!0}).then(()=>(console.log("MongoDB connected successfully"),t().connection.on("error",e=>{console.error("MongoDB connection error:",e),1!==t().connection.readyState&&(i.conn=null,i.promise=null)}),t().connection.on("disconnected",()=>{console.warn("MongoDB disconnected"),1!==t().connection.readyState&&(i.conn=null,i.promise=null)}),t().connection.on("connected",()=>{console.log("MongoDB connected")}),t().connection.on("reconnected",()=>{console.log("MongoDB reconnected"),i.conn=e}),e))}catch(e){throw console.error("Error creating MongoDB connection:",e),i.promise=null,e}try{let e;console.log("Waiting for connection to be established...");let n=0;for(;n<3;)try{return i.conn=await i.promise,console.log("Connection established successfully"),i.conn}catch(o){e=o,n++,console.error(`Failed to establish connection (attempt ${n}/3):`,o),n<3&&(console.log(`Retrying in ${2*n} seconds...`),await new Promise(e=>setTimeout(e,2e3*n)),i.promise=null)}throw console.error("Max retries reached, could not establish connection"),e}catch(e){throw console.error("Error establishing MongoDB connection:",e),i.promise=null,e}}},6864:(e,n,o)=>{o.d(n,{l:()=>a,R:()=>c});let r=require("jsonwebtoken");var t=o.n(r),s=o(8208);if(!process.env.JWT_SECRET)throw Error("Please define the JWT_SECRET environment variable inside .env.local");let i=process.env.JWT_SECRET;async function a(e,n,o){try{let r;console.log("\n=== START: Auth Middleware ==="),console.log("Method:",e.method),console.log("Path:",e.url);let a=e.headers.authorization;if(!a?.startsWith("Bearer "))return console.log("No token provided"),n.status(401).json({message:"No token provided"});let c=a.split(" ")[1];console.log("Token received, verifying...");try{r=t().verify(c,i),console.log("Token verified, user ID:",r.id)}catch(e){if(console.error("Token verification error:",e),e instanceof t().TokenExpiredError)return n.status(401).json({message:"Token expired"});return n.status(401).json({message:"Invalid token"})}let l=await s.n.findById(r.id).select("-password");if(!l)return console.log("User not found for ID:",r.id),n.status(401).json({message:"User not found"});console.log("User found:",l._id),e.user=l,console.log("=== END: Auth Middleware ===\n");try{await o()}catch(e){return console.error("Error in route handler:",e),n.status(500).json({message:"Internal server error",error:e instanceof Error?e.message:"Unknown error"})}}catch(e){return console.error("Auth middleware error:",e),n.status(500).json({message:"Authentication failed",error:e instanceof Error?e.message:"Unknown error"})}}function c(e){return t().sign({id:e},i,{expiresIn:"7d"})}},8208:(e,n,o)=>{o.d(n,{n:()=>c});var r=o(1185),t=o.n(r);let s=require("bcryptjs");var i=o.n(s);let a=new(t()).Schema({email:{type:String,required:!0,unique:!0,trim:!0,lowercase:!0},username:{type:String,required:!0,unique:!0,trim:!0,lowercase:!0,minlength:3,maxlength:30,match:[/^[a-zA-Z0-9_]+$/,"Username can only contain letters, numbers and underscores"]},password:{type:String,required:!0,minlength:6},name:{type:String,required:!0,trim:!0},friends:[{type:t().Schema.Types.ObjectId,ref:"User"}],friendRequests:[{from:{type:t().Schema.Types.ObjectId,ref:"User",required:!0},createdAt:{type:Date,default:Date.now}}],lastCheckIn:{type:Date,default:null}},{timestamps:!0});a.pre("save",async function(e){if(!this.isModified("password"))return e();try{let n=await i().genSalt(10);this.password=await i().hash(this.password,n),e()}catch(n){e(n)}}),a.methods.comparePassword=async function(e){return i().compare(e,this.password)};let c=t().models.User||t().model("User",a)},7153:(e,n)=>{var o;Object.defineProperty(n,"x",{enumerable:!0,get:function(){return o}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(o||(o={}))},1802:(e,n,o)=>{e.exports=o(145)}};var n=require("../../../webpack-api-runtime.js");n.C(e);var o=n(n.s=6644);module.exports=o})();